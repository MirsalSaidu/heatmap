<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Visitor Analytics - HeatmapiQ</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  <!-- Same styles as in dashboard.html -->
</head>
<body>
  <!-- Sidebar same as in dashboard.html -->
  
  <div class="main-content">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1 class="mb-0">Visitor Analytics</h1>
      <button class="btn btn-primary" id="export-visitors">
        <i class="bi bi-download me-2"></i> Export Data
      </button>
    </div>
    
    <div class="row g-4 mb-4">
      <div class="col-md-4">
        <div class="card stat-card">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="mb-0 text-white-50">Unique Visitors</h6>
              <h2 class="stat-value mb-0" id="uniqueVisitors">0</h2>
            </div>
            <div class="stat-icon">
              <i class="bi bi-people"></i>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-md-4">
        <div class="card stat-card" style="background: linear-gradient(45deg, var(--info), var(--success));">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="mb-0 text-white-50">Average Time on Page</h6>
              <h2 class="stat-value mb-0" id="avgTimeOnPage">0:00</h2>
            </div>
            <div class="stat-icon">
              <i class="bi bi-clock"></i>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-md-4">
        <div class="card stat-card" style="background: linear-gradient(45deg, var(--warning), var(--danger));">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="mb-0 text-white-50">Mobile Traffic</h6>
              <h2 class="stat-value mb-0" id="mobileTraffic">0%</h2>
            </div>
            <div class="stat-icon">
              <i class="bi bi-phone"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="row g-4">
      <div class="col-lg-6">
        <div class="card p-3 mb-4">
          <h5 class="card-title mb-3">Browser Distribution</h5>
          <canvas id="browserChart" height="250"></canvas>
        </div>
      </div>
      
      <div class="col-lg-6">
        <div class="card p-3 mb-4">
          <h5 class="card-title mb-3">Device Type</h5>
          <canvas id="deviceChart" height="250"></canvas>
        </div>
      </div>
      
      <div class="col-lg-12">
        <div class="card p-3 mb-4">
          <h5 class="card-title mb-3">Recent Visitors</h5>
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Time</th>
                  <th>Session ID</th>
                  <th>Browser</th>
                  <th>OS</th>
                  <th>Device</th>
                  <th>Referrer</th>
                  <th>Page</th>
                  <th>Duration</th>
                </tr>
              </thead>
              <tbody id="visitorTable">
                <!-- Visitor rows will be added here dynamically -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Load visitor data
      loadVisitorStats();
      
      function loadVisitorStats() {
        fetch('/api/visitors')
          .then(res => res.json())
          .then(data => {
            updateVisitorStats(data);
            updateVisitorCharts(data);
            populateVisitorTable(data.recentVisitors);
          })
          .catch(err => {
            console.error('Error loading visitor data:', err);
          });
      }
      
      function updateVisitorStats(data) {
        document.getElementById('uniqueVisitors').textContent = data.uniqueVisitors;
        
        // Format time on page (seconds to MM:SS)
        const avgSeconds = data.avgTimeOnPage || 0;
        const minutes = Math.floor(avgSeconds / 60);
        const seconds = Math.floor(avgSeconds % 60);
        document.getElementById('avgTimeOnPage').textContent = 
          `${minutes}:${seconds < 10 ? '0' + seconds : seconds}`;
        
        // Format mobile percentage
        document.getElementById('mobileTraffic').textContent = 
          `${Math.round(data.mobilePercentage || 0)}%`;
      }
      
      function updateVisitorCharts(data) {
        // Browser chart
        new Chart(document.getElementById('browserChart'), {
          type: 'pie',
          data: {
            labels: data.browsers.map(b => b.name),
            datasets: [{
              data: data.browsers.map(b => b.count),
              backgroundColor: [
                '#4361ee', '#3a0ca3', '#4895ef', '#4cc9f0', '#f72585',
                '#7209b7', '#3f37c9', '#4361ee', '#4895ef', '#4cc9f0'
              ]
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                position: 'right',
              }
            }
          }
        });
        
        // Device type chart
        new Chart(document.getElementById('deviceChart'), {
          type: 'doughnut',
          data: {
            labels: ['Desktop', 'Mobile', 'Tablet'],
            datasets: [{
              data: [
                data.deviceTypes.desktop || 0,
                data.deviceTypes.mobile || 0,
                data.deviceTypes.tablet || 0
              ],
              backgroundColor: ['#4361ee', '#f72585', '#4cc9f0']
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                position: 'right',
              }
            }
          }
        });
      }
      
      function populateVisitorTable(visitors) {
        const table = document.getElementById('visitorTable');
        table.innerHTML = '';
        
        visitors.forEach(visitor => {
          const row = document.createElement('tr');
          
          // Format timestamp
          const date = new Date(visitor.entry_timestamp);
          const formattedTime = date.toLocaleString();
          
          // Calculate duration
          let duration = 'N/A';
          if (visitor.visible_time) {
            const seconds = Math.floor(visitor.visible_time / 1000);
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            duration = `${minutes}:${remainingSeconds < 10 ? '0' + remainingSeconds : remainingSeconds}`;
          }
          
          row.innerHTML = `
            <td>${formattedTime}</td>
            <td>${visitor.session_id.substring(0, 8)}...</td>
            <td>${visitor.browser_name} ${visitor.browser_version}</td>
            <td>${visitor.os_name} ${visitor.os_version}</td>
            <td>${visitor.is_mobile ? 'Mobile' : 'Desktop'}</td>
            <td>${visitor.referrer || 'Direct'}</td>
            <td>${visitor.initial_url.split('/').pop() || 'Homepage'}</td>
            <td>${duration}</td>
          `;
          
          table.appendChild(row);
        });
      }
      
      // Handle export button
      document.getElementById('export-visitors').addEventListener('click', function() {
        fetch('/api/visitors/export')
          .then(res => res.json())
          .then(data => {
            // Create CSV content
            let csvContent = "data:text/csv;charset=utf-8,";
            
            // Add headers
            const headers = [
              "Session ID", "Browser", "OS", "Mobile?", "Screen", "Referrer", 
              "URL", "Timestamp", "Duration", "Timezone", "Language"
            ];
            csvContent += headers.join(",") + "\n";
            
            // Add data rows
            data.forEach(visitor => {
              const row = [
                visitor.session_id,
                `${visitor.browser_name} ${visitor.browser_version}`,
                `${visitor.os_name} ${visitor.os_version}`,
                visitor.is_mobile ? "Yes" : "No",
                visitor.screen_resolution,
                visitor.referrer || "Direct",
                visitor.initial_url,
                visitor.entry_timestamp,
                visitor.visible_time ? Math.floor(visitor.visible_time / 1000) + "s" : "N/A",
                visitor.timezone,
                visitor.language
              ].map(value => `"${String(value).replace(/"/g, '""')}"`);
              
              csvContent += row.join(",") + "\n";
            });
            
            // Create download link
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "visitor_data.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
          })
          .catch(err => {
            console.error('Error exporting visitor data:', err);
            alert('Failed to export data. Please try again.');
          });
      });
    });
  </script>
</body>
</html> 